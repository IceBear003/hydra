# Hydra小队 全技术细节

## **高速多端口共享缓存管理模块**

### 基本概念

SRAM参数：32块，位宽16，深度16384

端口参数：wr_data和rd_data位宽均为16，其他接口位宽均为1

半字（half word）：16bits，即2bytes

页（page）：8半字，即128bits，16bytes

物理地址（phsical address）：与SRAM交互时直接使用的地址，可以认为每个物理地址可在SRAM中访问到一个半字的信息。由于SRAM的深度为16384，故对于一个SRAM来说，物理地址为14位，又由于共有32块SRAM，故相对于外界而言，物理地址为5+14位，描述了哪一块SRAM的哪一个半字。

线性地址（linear address）：与SRAM交互时间接使用的地址，一个线性地址可生成八个物理地址，映射关系成线性。可以认为每个线性地址对应一页。由于SRAM共有2048页，对于一个SRAM来说，线性地址为11位，又由于共有32块SRAM，故相对于外界而言，线性地址有5+11位，描述了哪一块SRAM的哪一页。

### 数据包

#### 包参数

由题干可知，一个数据包长度为64~1024字节，合32~512半字/4~64页。

#### 包格式

数据包从端口写入时，由控制和数据部分组成，现拟定控制部分长16位，由9位长度、3位优先级、4位目的端口号组成。其中9位长度为数据包有多少半字（与512相对应）。

#### 存储形式

SRAM分配空间时以页为单位，即对于N字节的数据包，其占用的空间为⌈N/16⌉，即最后一页可能只有一部分有数据。同一个数据包分配的页不一定全部连续。

存入1页需要写入8半字，因此也就需要8个周期。当数据源源不断地从端口每半字地写入，每半字都在1个周期后立刻写入SRAM（此机制将在时序章节中详细说明）。

存储在SRAM里时，数据包仍然具有控制部分，但与从端口写入时略有区别。此时第一个半字并非9+3+4的形式，而是(2+)6+(5+)3的形式，其中6位数字X表示数据包占X+1页（与数据包最多64页对应），3位数字Y表示数据包的最后一页有Y+1半字（与1页有8半字对应）。可以注意到，这里的X和Y实际上就是原来的9位长度从中间拆分开直接得到。

#### 纠错策略

本模块使用传统的ECC汉明校验，每1页数据生成8位校验码。运算校验码时采用了异或树的结构，大大缩短了运算时间（从127次串行运算变为7次串并行运算）。

校验码存储在SRAM外部，每个SRAM都包含一个长度为2048的8位数字数组，分别对应SRAM中每一页的纠错信息，因此任意一页的纠错码存储位置可直接通过线性地址描述。

当1页的数据写入完毕时，校验码将会生成并存储在对应的位置。当1页的数据读出时，校验码将会被取出并参与SEC过程，可以注意到，对于1页中第1半字的数据，需要等到第8半字的数据取出才能被纠错，这会导致读数据滞后7个周期，本模块采用了预读取的策略，消除了该滞后（此机制将在时序章节中详细说明）。

#### 内存回收（内存碎片化待优化）

为了实现内存自动申请、回收的功能，本模块使用了空闲队列，一个类FIFO的数据结构，表述SRAM中哪些页是空闲的。由此可知，每一个SRAM都绑定一个空闲队列。

空闲队列本质上是一个宽度为16，深度为256的FIFO。空闲队列中每一个16位的元素，称为空闲区域描述符，由11位的头页线性地址A和5位的空闲区域长度L组成，描述了一连串线性地址相邻的空闲的页（第一页的线性地址是A，最后一页的线性地址为A+L）。可以注意到，每个描述符最多描述2^5=32页，若一连串一连串线性地址相邻的空闲的页数量大于32，超出的页会由新的描述符描述。

当新一页的数据写入SRAM时，将会直接从空闲队列头弹出一页作为线性地址，生成物理地址完成写操作；当读出一页数据时，意味着其原本占用的页重新回到了空闲状态，该页的地址将会被推入队尾，等待后续被弹出重新利用。这样就完成了时间复杂度为O(1)的内存分配、回收机制。

值得注意的是，若推入的线性地址与队尾的描述符对应的一连串页相邻，它会尝试并入其中；同样地，弹出线性地址时，弹出的并非第一个描述符，而是第一个描述符对应一连串页的第一页，之后原来的第N页将会变为新的N-1页。因此，空闲队列是一个被压缩的FIFO结构。

单悬挂、多吸附策略解决内存碎片化//TODO

好处：使得内存碎片最小为2，避免极端碎片化，压缩空闲FIFO至32KB占用，压缩指导表至64KB



### 端口



### 时序细节

### 模块

### 亮点

### 缺点

